name: Deploy (FTPS)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-ftps-main
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to shared hosting (FTPS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug (DNS + FTPS handshake)
        shell: bash
        run: |
          set -euo pipefail
          echo "Host: ${{ secrets.FTP_SERVER }}"
          echo "Resolving DNS..."
          getent hosts "${{ secrets.FTP_SERVER }}" || true
          echo
          echo "Testing explicit FTPS handshake on port 21..."
          # This does not authenticate; it only verifies that STARTTLS works.
          echo | openssl s_client -starttls ftp -connect "${{ secrets.FTP_SERVER }}:21" -servername "${{ secrets.FTP_SERVER }}" -brief

      # Deploys repository files to a shared-hosting account over FTPS.
      #
      # Required GitHub Secrets:
      # - FTP_SERVER: e.g. ftp.example.com
      # - FTP_USERNAME
      # - FTP_PASSWORD
      # - FTP_REMOTE_DIR: e.g. /tele-fleet.saptransportationandlogistics.ng/
      #
      # Notes:
      # - This repository ignores /vendor (see .gitignore). Your server must already have vendor/ installed.
      # - We exclude .env and storage/ to avoid overwriting server environment and runtime data.
      - name: Install lftp
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y lftp

      # Some shared-hosting FTPS servers intermittently close (FIN) connections for certain clients.
      # lftp's mirror is generally more resilient and will retry/reconnect automatically.
      - name: Upload via lftp (explicit FTPS)
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
        run: |
          set -euo pipefail

          # Use explicit FTPS (AUTH TLS) on port 21.
          # Certificate verification is disabled because many shared hosts use mismatched/chain issues.
          lftp -e "
            set ssl:verify-certificate no;
            set ftp:ssl-force true;
            set ftp:ssl-protect-data true;
            set ftp:passive-mode true;
            set net:max-retries 20;
            set net:reconnect-interval-base 5;
            set net:reconnect-interval-multiplier 1;
            set net:timeout 30;
            set cmd:fail-exit true;

            open -p 21 -u \"${FTP_USERNAME}\",\"${FTP_PASSWORD}\" \"ftp://${FTP_SERVER}\";

            # Deploy into remote directory. Depending on your host, this may be relative to /home/<user>/.
            # Examples: \"public_html\", \"tolataste\", or \"/home/tolatast/tolataste\".
            cd \"${FTP_REMOTE_DIR}\";

            mirror -R \
              --only-newer \
              --verbose \
              --parallel=1 \
              --exclude-glob .git/ \
              --exclude-glob .github/ \
              --exclude-glob node_modules/ \
              --exclude-glob tests/ \
              --exclude-glob storage/ \
              --exclude-glob bootstrap/cache/ \
              --exclude-glob vendor/ \
              --exclude-glob secure/ \
              --exclude-glob .env \
              --exclude-glob .env.* \
              ./ .;

            bye
          "
