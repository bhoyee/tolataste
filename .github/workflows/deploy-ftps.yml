name: Deploy (FTPS)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

concurrency:
  group: deploy-ftps-main
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to shared hosting (FTPS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug (DNS + FTPS handshake)
        shell: bash
        run: |
          set -euo pipefail
          echo "Host: ${{ secrets.FTP_SERVER }}"
          echo "Resolving DNS..."
          getent hosts "${{ secrets.FTP_SERVER }}" || true
          echo
          echo "Testing explicit FTPS handshake on port 21..."
          # This does not authenticate; it only verifies that STARTTLS works.
          echo | openssl s_client -starttls ftp -connect "${{ secrets.FTP_SERVER }}:21" -servername "${{ secrets.FTP_SERVER }}" -brief

      # Deploys repository files to a shared-hosting account over FTPS.
      #
      # Required GitHub Secrets:
      # - FTP_SERVER: e.g. ftp.example.com
      # - FTP_USERNAME
      # - FTP_PASSWORD
      # - FTP_REMOTE_DIR: e.g. /tele-fleet.saptransportationandlogistics.ng/
      #
      # Notes:
      # - This repository ignores /vendor (see .gitignore). Your server must already have vendor/ installed.
      # - We exclude .env and storage/ to avoid overwriting server environment and runtime data.
      - name: Install lftp
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y lftp zip

      # Some shared-hosting FTPS servers intermittently close (FIN) connections for certain clients.
      # lftp's mirror is generally more resilient and will retry/reconnect automatically.
      # If your host still drops long transfers (lots of small files), switch to zip upload:
      # - Set GitHub Secret DEPLOY_STRATEGY=zip
      # - Upload will place a single deploy.zip on the server; extract it in cPanel File Manager.
      - name: Upload via lftp (explicit FTPS)
        shell: bash
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_REMOTE_DIR: ${{ secrets.FTP_REMOTE_DIR }}
          DEPLOY_STRATEGY: ${{ secrets.DEPLOY_STRATEGY }}
        run: |
          set -euo pipefail

          STRATEGY="${DEPLOY_STRATEGY:-mirror}"
          echo "Deploy strategy: ${STRATEGY}"

          if [[ "${STRATEGY}" == "zip" ]]; then
            echo "Creating deploy.zip..."
            rm -f deploy.zip
            zip -r deploy.zip . \
              -x ".git/*" ".git/**" \
              -x ".github/*" ".github/**" \
              -x "node_modules/*" "node_modules/**" \
              -x "tests/*" "tests/**" \
              -x "storage/*" "storage/**" \
              -x "bootstrap/cache/*" "bootstrap/cache/**" \
              -x "vendor/*" "vendor/**" \
              -x "secure/*" "secure/**" \
              -x ".env" ".env.*"
          fi

          # Use explicit FTPS (AUTH TLS) on port 21.
          # Certificate verification is disabled because many shared hosts use mismatched/chain issues.
          lftp -e "
            set ssl:verify-certificate no;
            set ftp:ssl-force true;
            set ftp:ssl-protect-data true;
            set ftp:passive-mode true;
            set net:max-retries 20;
            set net:reconnect-interval-base 5;
            set net:reconnect-interval-multiplier 1;
            set net:timeout 30;
            set cmd:fail-exit true;

            open -p 21 -u \"${FTP_USERNAME}\",\"${FTP_PASSWORD}\" \"ftp://${FTP_SERVER}\";

            # Deploy into remote directory. Depending on your host, this may be relative to /home/<user>/.
            # Examples: \"public_html\", \"tolataste\", or \"/home/tolatast/tolataste\".
            cd \"${FTP_REMOTE_DIR}\";

            if [ \"${STRATEGY}\" = \"zip\" ]; then
              put -O . deploy.zip;
            else
              mirror -R \
                --only-newer \
                --verbose \
                --parallel=1 \
                --exclude-glob .git/ \
                --exclude-glob .github/ \
                --exclude-glob node_modules/ \
                --exclude-glob tests/ \
                --exclude-glob storage/ \
                --exclude-glob bootstrap/cache/ \
                --exclude-glob vendor/ \
                --exclude-glob secure/ \
                --exclude-glob .env \
                --exclude-glob .env.* \
                ./ .;
            fi

            bye
          "
